# 将棋GUI モード切替機能仕様書

## 1. 概要

将棋GUIアプリケーションにおいて、以下の3つのモードを切り替えて使用できるようにします：

1. **対局モード**：実際の対局を行うための基本モード
2. **編集モード**：任意の局面を作成・編集するためのモード
3. **検討モード**：過去の手順を確認したり、新しい手順を検討したりするモード

## 仕様書一覧

本機能の詳細仕様は以下のドキュメントに記載されています：

### 基本設計
- [API仕様書](api_spec.md) - REST APIエンドポイントとデータ構造の定義
- [データベース設計仕様書](database_spec.md) - テーブル設計、マイグレーション計画
- [フロントエンド実装仕様書](frontend_spec.md) - UIコンポーネント、状態管理の設計

### 状態管理
- [状態遷移図](state_diagram.puml) - モード間の遷移と状態の定義
- [状態保持仕様書](state_preservation.md) - モード切替時のデータ保持方法

### 実装計画
- [実装計画書](implementation_plan.md) - 開発フェーズ、スケジュール、リスク管理

## ドキュメント構成の説明

- **api_spec.md**: 
  - モード切替用のAPIエンドポイント
  - リクエスト/レスポンス形式
  - エラー定義

- **database_spec.md**:
  - テーブル定義（新規作成・既存テーブル変更）
  - データ型とインデックス
  - マイグレーション手順
  - バックアップ戦略

- **frontend_spec.md**:
  - コンポーネント構成
  - 状態管理（Pinia Store）
  - UI/UX設計
  - エラーハンドリング

- **state_diagram.puml**:
  - 各モードの状態定義
  - モード間の遷移ルール
  - 状態遷移の制約条件
  - エラー状態の定義

- **state_preservation.md**:
  - モード切替時のデータ保存
  - 状態復元ロジック
  - エラーリカバリ
  - パフォーマンス考慮事項

- **implementation_plan.md**:
  - 実装フェーズの定義
  - リスク分析と対策
  - テスト計画
  - デプロイメント計画

## ドキュメント更新ガイドライン

1. 仕様変更時は関連する全てのドキュメントを更新
2. PlantUML図は変更時に必ずプレビューで確認
3. APIの変更はSwagger定義も同時に更新
4. 実装計画の変更は関係者に通知

## 2. 機能要件

### 2.1 対局モード

- 通常の対局機能を提供
- 先手・後手が交互に指し手を入力
- 以下の操作が可能：
  - 駒の移動
  - 持ち駒の使用
  - 投了
  - 待った
    - 直前の1手のみ取り消し可能

### 2.2 編集モード

- 盤面を自由に編集可能
- 以下の操作が可能：
  - 駒の配置
  - 駒の削除
  - 駒の成り/不成りの切り替え
  - 持ち駒の増減
  - 手番の切り替え
- 編集完了後、その局面から対局モードまたは検討モードへ移行可能

### 2.3 検討モード

- 棋譜の再生・編集機能を提供
- 以下の操作が可能：
  - 任意の局面への移動
  - 新しい手順の追加（分岐の作成）
  - 手順の削除
  - コメントの追加
- 検討モード中は、対局モードのルール（手番制約など）を適用しない

## 3. UI仕様

### 3.1 モード切替UI

- 画面上部にモード切替タブまたはドロップダウンを配置
- 現在のモードを視覚的に明確に表示
- モード切替時は確認ダイアログを表示（必要な場合）

### 3.2 モード別UI要素

#### 対局モード
- 基本的な将棋盤UI
- 持ち駒表示
- 手番表示
- 投了ボタン

#### 編集モード
- 駒選択パレット
- 成り駒切替ボタン
- 手番切替ボタン
- 局面保存/読み込みボタン

#### 検討モード
- 棋譜表示パネル
- 分岐表示/選択UI
- コメント入力エリア
- ナビゲーションコントロール（進む/戻る）

## 4. データ設計

### 4.1 モード状態管理

```typescript
enum GameMode {
  PLAY = 'play',      // 対局モード
  EDIT = 'edit',      // 編集モード
  STUDY = 'study'     // 検討モード
}

interface GameState {
  currentMode: GameMode;
  // その他の状態...
}
```

### 4.2 局面データ構造

```typescript
interface BoardState {
  sfen: string;           // 現在の局面
  activePlayer: Player;   // 手番
  moves: Move[];         // 指し手履歴
  branchInfo?: Branch;   // 検討モード用の分岐情報
  editHistory?: Edit[];  // 編集モード用の編集履歴
}
```

## 5. 状態遷移

### 5.1 モード間の遷移ルール

1. 対局モード → 編集モード
   - 確認ダイアログを表示
   - 現在の対局情報を保存

2. 対局モード → 検討モード
   - 自動的に現在の局面までの棋譜を保持
   - 分岐の作成が可能に

3. 編集モード → 対局モード
   - 編集内容の確定確認
   - 初期局面として設定

4. 編集モード → 検討モード
   - 編集した局面を初期局面として設定
   - 新しい検討を開始

5. 検討モード → 対局モード
   - 現在の局面から新規対局を開始
   - 棋譜の保存確認

6. 検討モード → 編集モード
   - 現在の局面を編集モードで開く
   - 検討内容の保存確認

## 6. エラー処理

### 6.1 モード切替時のエラー

- 不正な局面でのモード切替防止
- 保存されていない変更がある場合の警告
- 編集モードでの無効な駒配置の検出

### 6.2 操作制限

- 各モードで許可されない操作の無効化
- モード別の操作制限の実装
- 不正な操作時のフィードバック表示
- 待った機能の制限
  - 対局モードでのみ有効
  - 設定で無効化されている場合は使用不可
  - 制限回数を超えた場合は使用不可
  - 直前の手以外は取り消し不可
  - 両対局者の同意が得られない場合は実行不可
  - タイムアウト時は要求が自動的にキャンセル

## 7. 実装方針

### 7.1 フロントエンド

- Vue.jsのコンポーネント構造の拡張
- モード別のUIコンポーネントの作成
- 状態管理（Pinia）の拡張

### 7.2 バックエンド

- モード別のAPIエンドポイント作成
- 局面の検証ロジック実装
- データベーススキーマの拡張

## 8. テスト計画

### 8.1 ユニットテスト

- モード切替ロジックのテスト
- 各モード固有の機能のテスト
- エラー処理のテスト

### 8.2 統合テスト

- モード間の遷移テスト
- データの永続化テスト
- UI操作の一貫性テスト

### 8.3 E2Eテスト

- 実際の利用シナリオに基づくテスト
- 全モードを跨ぐ操作シーケンスのテスト

## 9. 今後の拡張性

- AIエンジンとの連携
- 複数のウィンドウでの同時検討
- 検討結果の共有機能
- 定跡データベースとの連携

## 10. 制約事項

- モード切替時のパフォーマンス考慮
- メモリ使用量の最適化
- ブラウザの互換性確保
- ネットワーク切断時の動作保証

## 11. データモデル

### 11.1 対局設定データ構造

```typescript
interface GameSettings {
  // ...existing code...
  takeBackSettings: {
    enabled: boolean;           // 待った機能の有効/無効
    maxTakeBacksPerGame: number; // 1局あたりの制限回数（デフォルト3）
    requestTimeoutSeconds: number; // 待った要求のタイムアウト時間（秒）
  };
  // ...existing code...
}
```

### 11.2 待った要求データ構造

```typescript
interface TakeBackRequest {
  gameId: string;           // 対局ID
  requesterId: string;      // 要求者のユーザーID
  moveNumber: number;       // 取り消したい手の番号
  requestedAt: Date;        // 要求日時
  status: 'pending' | 'accepted' | 'rejected' | 'timeout'; // 要求の状態
  responseAt?: Date;        // 応答日時
}
```

### 11.3 待った履歴データ構造

```typescript
interface TakeBackHistory {
  gameId: string;           // 対局ID
  moveNumber: number;       // 取り消された手の番号
  requesterId: string;      // 要求者のユーザーID
  accepterId: string;       // 承認者のユーザーID
  executedAt: Date;         // 実行日時
  previousSfen: string;     // 取り消し前のSFEN
  currentSfen: string;      // 取り消し後のSFEN
}

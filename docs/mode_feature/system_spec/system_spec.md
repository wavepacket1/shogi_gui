# モード切替機能 システム仕様書

## 1. 概要
将棋GUIアプリケーションにおいて、以下の3つのモードを切り替えて使用できる機能を提供します。
1. 対局モード: 実際の対局を行う機能
2. 編集モード: 任意の局面を作成・編集する機能
3. 検討モード: 局面の再生・分岐検討・コメント追加機能

## 2. 機能要件

### 2.1 対局モード
- 通常の対局機能を提供
- 先手・後手が交互に指し手を入力
- 以下の操作が可能:
  - 駒の移動
  - 持ち駒の使用
  - 投了

### 2.2 編集モード
- 盤面を自由に編集可能（盤面と持ち駒の合計枚数は常に一定）
- 以下の操作が可能:
  - 駒の配置
  - 駒の成り/不成りの切り替え
  - 持ち駒の増減
  - 手番の切り替え
- 編集完了後、その局面から対局モードまたは検討モードへ移行可能
- 編集完了の検知: 初期局面（SFENなど）との差分比較または `unsavedChanges` フラグを用意し、変更が存在しない状態で遷移を許可

### 2.3 検討モード

#### 2.3.1 基本機能
- 棋譜の再生・分岐検討機能を提供
- 任意の局面への移動
- 新しい手順の追加（分岐の作成）
- 手順の削除
- コメントの追加・編集・削除
- 合法手のみを許可（基本的な将棋ルールに準拠）

#### 2.3.2 コメント機能
**機能概要:**
- 各局面に対してテキストコメントを追加可能
- マルチライン入力対応
- 自動保存機能
- コメント履歴管理

**詳細仕様:**
- MoveHistoryPanelの各手順項目にコメントアイコン（💬）を表示
- コメントが存在する場合はアイコンを青色で表示
- アイコンクリックでコメント編集エリアを表示/非表示
- テキストエリアでの入力中、3秒間の無入力後に自動保存
- コメント削除ボタン（🗑️）を提供
- 最大文字数制限: 1000文字

**データ構造:**
```typescript
interface Comment {
  id: number;
  board_history_id: number;
  content: string;
  created_at: string;
  updated_at: string;
}

interface StudyState {
  comments: Record<number, Comment[]>; // board_history_id -> comments[]
  editingCommentId: number | null;
  autoSaveTimer: number | null;
}
```

#### 2.3.3 分岐管理機能

**新しい分岐作成:**
- 各手順項目に「+」ボタンを表示（ホバー時のみ表示）
- クリック時に分岐名入力ダイアログを表示
- 分岐名は自動生成（variation-1, variation-2...）または手動入力可能
- 分岐名の制限: 英数字と-_のみ、最大20文字
- 作成後は新分岐に自動切り替え
- 作成時点の局面から新分岐が開始

**分岐削除:**
- 分岐セレクタに削除ボタン（🗑️）を追加
- main分岐は削除不可
- 削除確認ダイアログを表示: 「分岐'[分岐名]'を削除しますか？この操作は取り消せません。」
- コメントが存在する場合は追加警告: 「この分岐にはコメントが含まれています。」
- 削除後はmain分岐に自動切り替え

**手順削除:**
- 各手順項目に削除ボタン（🗑️）を追加（ホバー時のみ表示）
- クリック時に確認ダイアログを表示: 「この手順以降をすべて削除しますか？」
- 削除実行後、指定手順以降の手順とコメントを連動削除
- main分岐の初期局面は削除不可

#### 2.3.4 合法手チェック機能
- 盤面から直接駒を動かして新手順を作成
- 通常の将棋ルール（合法手判定、王手回避等）に従い、合法手のみを許可
- 以下の制約は緩和される：
  - 千日手判定の無効化（同一局面の繰り返しを許可）
  - 詰み判定の無効化（詰みの局面でも手順を続行可能）
  - 時間制限の無効化
- 指し手入力時に新しい手順として自動保存
- 分岐がある場合は現在の分岐に追加
- 不正な手（非合法手）を入力した場合はエラー表示

#### 2.3.5 局面コピー機能
- 「局面コピー」ボタンを提供
- 現在の局面をSFEN形式でクリップボードにコピー
- コピー完了時にトースト通知を表示
- 他の将棋ソフトとの連携を想定

#### 2.3.6 ナビゲーション機能
- 最初の局面に移動（|◀）
- 一手戻る（◀）
- 一手進む（▶）
- 最後の局面に移動（▶|）
- キーボードショートカット対応:
  - ← キー: 一手戻る
  - → キー: 一手進む
  - Home キー: 最初の局面
  - End キー: 最後の局面

## 3. UI仕様

### 3.1 モード切替UI
- 画面上部にモード切替タブまたはドロップダウンを配置
- 現在のモードを視覚的に明確に表示
- モード切替時は即時で切り替え、確認ダイアログは不要

### 3.2 モード別UI要素

#### 対局モード
- 基本的な将棋盤UI
- 先手の持ち駒表示エリア（常に表示）
- 後手の持ち駒表示エリア（常に表示）
- 手番表示
- 投了ボタン

#### 編集モード
- モード切替タブ
- 手番変更ボタン
- 手番表示
- 先手の持ち駒表示エリア
- 後手の持ち駒表示エリア
- 編集用将棋盤（駒操作は盤面上で直接行う）

#### 検討モード
**レイアウト構成:**
- 左側: 将棋盤（60%）
- 右側: MoveHistoryPanel（40%）

**MoveHistoryPanel詳細仕様:**
```typescript
interface MoveHistoryPanelProps {
  gameId: number;
  mode: 'play' | 'edit' | 'study';
  allowEdit: boolean; // 編集可能かどうか
  showComments: boolean; // コメント表示するか
}
```

**UI要素:**
- パネルヘッダー:
  - タイトル: "棋譜"
  - 分岐セレクタ（複数分岐がある場合のみ表示）
  - 分岐削除ボタン（main以外の分岐選択時のみ表示）
- ナビゲーションコントロール:
  - |◀ ◀ ▶ ▶| ボタン
  - 局面コピーボタン
- 手順リスト:
  - 各手順項目の構成:
    - 手順番号
    - 指し手表記
    - コメントアイコン（💬）
    - 分岐作成ボタン（+、ホバー時表示）
    - 削除ボタン（🗑️、ホバー時表示）
  - アクティブ手順のハイライト
  - 分岐ごとの色分け表示

**コメント編集エリア:**
- 表示条件: コメントアイコンクリック時
- UI要素:
  - テキストエリア（5行、リサイズ可能）
  - 文字数カウンタ（例: 150/1000）
  - 自動保存インジケータ
  - 削除ボタン
  - 閉じるボタン（×）

### 3.3 視覚的改善
**分岐表示:**
- main分岐: 青色（#1976d2）
- variation分岐: 緑色（#388e3c）、橙色（#f57c00）等を循環使用
- アクティブ分岐: 太字表示

**手順表示:**
- 現在手順: 背景色強調
- ホバー時: 操作ボタン表示、軽い影効果
- コメント有無: アイコン色変更（グレー→青）

**状態表示:**
- 自動保存中: スピナーアイコン
- 保存完了: チェックマーク（1秒間表示）
- エラー時: 赤色警告アイコン

### 3.4 UIモックアップ (静的HTML)
以下のファイルにそれぞれのモード用モックアップを配置しています。ブラウザで開き、レイアウトイメージをご確認ください。
- `docs/mode_feature/adr/ui_ux_mockup.html`: 対局モード
- `docs/mode_feature/adr/ui_ux_edit_mockup.html`: 編集モード
- `docs/mode_feature/adr/ui_ux_analysis_mockup.html`: 検討モード

## 4. API仕様

### 4.1 コメント管理API
**基本パス:** `/api/v1/games/:game_id/board_histories/:move_number/comments`
**分岐指定:** クエリパラメータ `branch` で分岐を指定（デフォルト: main）

**エンドポイント:**
- `GET` - コメント一覧取得
- `POST` - 新規コメント作成
- `PUT /:id` - コメント更新
- `DELETE /:id` - コメント削除

**リクエスト/レスポンス例:**
```json
// POST リクエスト
{
  "comment": {
    "content": "この局面では角交換が有力です。"
  }
}

// レスポンス
{
  "comment_id": 123,
  "content": "この局面では角交換が有力です。",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

### 4.2 分岐管理API
**既存API活用:** BoardHistoriesController
- 分岐作成: 新しいboard_historyレコード作成
- 分岐削除: 該当branchのboard_historiesを一括削除
- 分岐一覧: 既存のfetchBranches API

### 4.3 手順削除API
**エンドポイント:** `DELETE /api/v1/games/:game_id/board_histories/:move_number/after`
**機能:** 指定手順以降をすべて削除
**パラメータ:** branch（デフォルト: main）

## 5. データベース仕様

### 5.1 既存テーブル活用
**board_histories:** 分岐・手順管理
- game_id, move_number, branch で手順を一意特定
- 分岐作成時は新しい branch 値でレコード作成

**comments:** コメント管理
- board_history_id で手順とコメントを関連付け
- content で実際のコメントテキストを保存

### 5.2 データ整合性
- 手順削除時は関連コメントも自動削除（外部キー制約）
- 分岐削除時は関連する全board_histories・commentsを一括削除

## 6. モード切替フロー
- モード切替時には、Gameオブジェクトの `mode` 属性を選択されたモードに更新するだけ
  - 例:`game.mode = GameMode.EDIT` や `game.mode = GameMode.STUDY`
- その他の局面・手番・手順履歴などの状態はそのまま維持
- UI は更新後の `game.mode` を参照して表示を切り替え

## 7. パフォーマンス要件

### 7.1 応答時間
- コメント保存: 1秒以内
- 分岐切り替え: 2秒以内
- 手順ナビゲーション: 0.5秒以内

### 7.2 データロード
- 初期表示: 棋譜100手まで3秒以内
- コメント一括取得: 50件まで2秒以内

### 7.3 メモリ使用量
- クライアント側コメントキャッシュ: 最大1000件
- 古いコメントは自動的にキャッシュから削除

## 8. エラー処理

### 8.1 モード切替時のエラー
- 不正な局面でのモード切替防止
- 未保存の変更がある場合の警告
- 編集モードでの無効な駒配置の検出

### 8.2 検討モード固有のエラー
**コメント関連:**
- 文字数超過: "コメントは1000文字以内で入力してください"
- 保存失敗: "コメントの保存に失敗しました。再試行してください"
- 削除失敗: "コメントの削除に失敗しました"

**分岐・手順操作:**
- 分岐名重複: "同じ名前の分岐が既に存在します"
- main分岐削除試行: "main分岐は削除できません"
- 手順削除失敗: "手順の削除に失敗しました"
- ネットワークエラー: "通信エラーが発生しました。接続を確認してください"

### 8.3 操作制限
- 各モードで許可されない操作の無効化
- 対応するエラーメッセージの表示
- 操作不可時のボタン無効化

## 9. セキュリティ要件

### 9.1 入力値検証
- コメント内容: HTMLタグエスケープ、XSS対策
- 分岐名: 英数字と-_のみ許可
- APIパラメータ: 型・範囲チェック

### 9.2 権限制御
- 自分が作成したゲームのみ編集可能
- ゲストユーザーは閲覧のみ可能

## 10. 注意事項
- 実装完了した後動作確認をして問題ないか検証すること(バッグエンド側、フロント側両方。フロント側はplaywrightを使って自動で動作確認して)
- UI/UXの大幅な変更は禁止
- 技術スタックのバージョンは変更しない
- 仕様変更時は各設計書を同時に更新
- 検討モードは段階的実装（Phase 1: コメント機能 → Phase 5: UI/UX改善） 
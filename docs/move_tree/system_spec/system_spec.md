# 分岐ツリー機能 システム仕様書

## 1. 概要
将棋GUIアプリケーションにおいて、棋譜の分岐を視覚的なツリー構造で表示・管理する機能を提供します。

## 2. 基本概念
- すべての棋譜は初期局面（0手目）から開始し、ツリー状の分岐構造を持つ
- main分岐を基幹とし、任意の手順から複数の分岐を作成可能
- 各分岐は独立した手順の流れを持つ
- 分岐は既存の手順と異なる手を指すことで自動的に生成される

## 3. 表示仕様
- **水平表示**: 同一分岐内の連続手順は水平（左→右）に配置
- **垂直分岐**: 異なる分岐は垂直方向に配置
- **矢印接続**: 手順間は矢印（→）で視覚的に接続

## 4. 分岐ツリーの表示例

### 4.1 基本的な分岐
```
初期局面 → ▲7六歩 → △3四歩 ┬─ ▲2六歩 → △4四歩 → ▲2五歩 (main)
                         ├─ ▲7八金 → △4四歩 → ▲6八銀 (id-1)
                         └─ ▲4八銀 → △3二金 → ▲6八玉 (id-2)
```

### 4.2 より複雑な分岐構造
```
初期局面 → ▲7六歩 → △3四歩 ┬─ ▲2六歩 ┬─ △4四歩 → ▲2五歩 (main)
                         │         └─ △8四歩 → ▲2五歩 (id-3)
                         ├─ ▲7八金 → △4四歩 → ▲6八銀 (id-1)
                         └─ ▲4八銀 ┬─ △3二金 → ▲6八玉 (id-2)
                                   └─ △4四歩 → ▲3六歩 (id-4)
```



## 5. 機能要件

### 5.1 分岐ツリービューア
- **表示モード**: モーダルダイアログで全画面表示
- **基本機能**: 
  - 全分岐を俯瞰できる専用ビューア
  - 各手順の指し手を明記（▲7六歩、△3四歩等）
  - 分岐間の関係性を矢印で明示
- **操作機能**:
  - 各ノードクリックで該当分岐・手順にジャンプ
  - 分岐の折りたたみ/展開
  - 現在位置のハイライト表示
- **UI要素**:
  - ×ボタンで閉じる
  - 統計情報表示（総手順数、分岐数）
  - スクロール対応（大量分岐時）

### 5.2 新しい分岐作成
- **作成方法**: 既存の手順と異なる手を指した時に自動的に生成
- **操作手順**: 任意の局面で既存の手順と異なる手を盤面から指すことで分岐作成
- **分岐命名規則**:
  - main分岐: 固定で「main」
  - 追加分岐: 「id-1」「id-2」「id-3」...の形式で自動生成
  - 命名ルール: 既存の最大ID番号+1で採番
  - 手動変更: 不可（自動生成のみ）
- **作成後動作**:
  - 新分岐に自動切り替え
  - 指した手が新分岐の最初の手順として記録

### 5.3 分岐削除
- **UI要素**: 分岐セレクタに削除ボタン（🗑️）を追加
- **制約**: main分岐は削除不可
- **連鎖削除**: 
  - 削除対象分岐の子分岐も再帰的に削除
  - 関連コメントも連動削除
- **確認ダイアログ**: 「分岐'[分岐名]'を削除しますか？」（簡潔な確認のみ）
- **削除後動作**: main分岐に自動切り替え

### 5.4 分岐ナビゲーション

#### 5.4.1 分岐切り替え
- **UI要素**: 画面上部に分岐選択ドロップダウンメニューを配置
- **表示内容**: "main", "id-1", "id-2"...の形式で全分岐を一覧表示
- **動作**: 
  - ドロップダウン選択により即座に分岐を切り替え
  - 移動先局面: 選択分岐の最後の手順（最大move_number）
  - 空分岐の処理: 分岐に手順がない場合は分岐開始点に移動
  - UI更新: 盤面、手順履歴、コメント、現在手数インデックスをすべて更新

#### 5.4.2 手順移動（分岐内ナビゲーション）
- **UI要素**: 手順履歴パネル内の各手順項目
- **操作方法**:
  - 手順項目をクリック→該当局面にジャンプ
  - 前へ/次へボタンで1手ずつ移動
  - キーボード矢印キー（←→）で移動
- **動作範囲**: 現在選択中の分岐内のみで移動（他分岐には移動しない）

#### 5.4.3 分岐ジャンプ（分岐間移動）
- **UI要素**: 分岐ツリービューア内の各手順ノード
- **操作方法**: ツリービューア上の任意の手順をクリック
- **動作**:
  - クリックした手順が属する分岐に自動切り替え
  - 該当する局面まで自動進行
  - 異なる分岐の手順でも1クリックで移動可能

### 5.5 +ボタン（代替手表示）機能
- **UI配置**: 各手順項目の右端に配置
- **表示条件**: 同一手数に他分岐の手が存在する場合のみ表示
- **非表示条件**: 代替手がない場合は+ボタン自体を非表示
- **展開UI**: 
  - クリック時にポップアップまたはドロップダウンで代替手一覧表示
  - 代替手フォーマット: 「▲7八金(id-1)」「▲4八銀(id-2)」の形式
- **分岐移動機能**:
  - 表示された代替手をクリックすると該当分岐に自動移動
  - 移動先分岐の該当手順まで局面を自動進行

## 6. 動作制約
- 分岐作成は既存の手順と異なる手を指すことでのみ可能
- 分岐削除時: 子分岐も連動削除される
- 手順削除時: 以降手順も連動削除される
- 分岐IDは自動生成でユニーク性を保証

## 7. エラーハンドリング
- **API通信エラー**: ローディング表示とエラーメッセージ表示
- **分岐名重複**: 作成時に同名分岐の存在確認（自動採番で回避）
- **無効な分岐操作**: 存在しない分岐への切り替え時の処理
- **ネットワーク断絶**: オフライン状態での操作制限
- **データ整合性**: 不正な分岐階層データの検出と修正

## 8. パフォーマンス要件
- **大量分岐対応**: 100分岐以上でも正常動作
- **遅延読み込み**: 分岐ツリーの必要な部分のみ取得
- **キャッシュ機能**: 一度取得した分岐データのメモリ保持
- **レスポンシブ表示**: 分岐ツリービューアの画面サイズ対応
- **スクロール最適化**: 大量手順時の仮想スクロール対応 
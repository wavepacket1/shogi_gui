# 将棋GUIアプリケーション仕様書

## 1. 概要

本アプリケーションは、将棋の対局をウェブブラウザ上で行うためのGUIアプリケーションです。バックエンドはRuby on Rails、フロントエンドはVue.jsで実装されています。

## 2. 機能一覧

### 2.1 基本機能
- 将棋盤の表示
- 駒の移動
- 駒の成り
- 持ち駒の管理
- 手番の管理
- 入玉宣言

### 2.2 局面管理機能
- 局面履歴の表示
- 局面の進行・巻き戻し
- 閲覧モードの切り替え

## 3. システム構成

### 3.1 バックエンド（Ruby on Rails）
- ゲーム管理
- 盤面管理
- 駒の移動ロジック
- 合法手判定
- 局面履歴の保存

### 3.2 フロントエンド（Vue.js）
- 将棋盤の描画
- ユーザーインターフェース
- 駒の移動アニメーション
- 局面履歴の表示

## 4. データモデル

### 4.1 Game
- ゲームの状態管理（アクティブ、終了、一時停止）
- 複数の盤面（Board）を持つ

### 4.2 Board
- 盤面の状態をSFEN形式で保存
- ゲームに属する
- 複数の駒（Piece）を持つ

### 4.3 Piece
- 駒の種類（歩、香、桂、銀、金、角、飛、玉）
- 駒の所有者（先手/後手）
- 駒の位置
- 成り状態

### 4.4 Move
- 駒の移動情報
- 移動元と移動先の座標
- 成りの有無

## 5. API仕様

### 5.1 ゲーム関連
- `POST /api/v1/games`: 新しいゲームを作成
- `GET /api/v1/games/:id`: 特定のゲームの情報を取得
- `POST /api/v1/games/:game_id/boards/:board_id/nyugyoku_declaration`: 入玉宣言を行う

### 5.2 盤面関連
- `GET /api/v1/boards/:id`: 特定の盤面の情報を取得
- `GET /api/v1/boards/default`: デフォルトの盤面を取得
- `GET /api/v1/games/:game_id/boards`: ゲームの全局面履歴を取得
- `GET /api/v1/games/:game_id/boards/:board_id`: 特定のゲームの特定の局面を取得

### 5.3 駒の移動関連
- `PATCH /api/v1/games/:game_id/boards/:board_id/move`: 駒を移動する

## 6. 局面管理機能の詳細仕様

### 6.1 局面履歴の取得
- ゲーム開始時に初期局面が作成される
- 駒が移動されるたびに新しい局面が作成され、履歴に追加される
- フロントエンドは`GET /api/v1/games/:game_id/boards`エンドポイントを使用して局面履歴を取得する

### 6.2 局面の進行・巻き戻し
- ユーザーは局面履歴内を自由に移動できる
- 「最初の局面へ」「前の局面へ」「次の局面へ」「最新の局面へ」の各ボタンで移動可能
- 現在表示中の局面が最新でない場合は「閲覧モード」となり、駒の移動が禁止される
- 最新の局面に戻ると通常の対局モードに戻る

### 6.3 閲覧モード
- 閲覧モード中は駒の移動や持ち駒の使用が禁止される
- 閲覧モード中は画面上に「閲覧モード」と表示される
- 最新の局面に移動すると閲覧モードが解除される

## 7. 実装の詳細

### 7.1 バックエンド
- `Game`モデルは複数の`Board`を持つ（has_many関連）
- 駒の移動時に新しい`Board`レコードが作成される
- 各`Board`はSFEN形式で盤面状態を保存する
- `BoardsController`の`index`アクションで局面履歴を取得可能
- `BoardsController`の`show_by_game`アクションで特定の局面を取得可能

### 7.2 フロントエンド
- `useBoardStore`ストアで局面履歴を管理
- `boardHistory`配列に局面履歴を保存
- `currentBoardIndex`で現在表示中の局面のインデックスを管理
- `isViewMode`フラグで閲覧モードかどうかを管理
- 駒の移動や持ち駒の使用後に局面履歴を更新
- ナビゲーションコントロールで局面間の移動を実現

## 8. 今後の拡張予定

### 8.1 棋譜の保存と読み込み
- 棋譜をKIF形式やCSA形式で保存・読み込み機能
- 棋譜のエクスポート・インポート機能

### 8.2 対局時計
- 持ち時間の設定と表示
- `[|<]`: 最初の局面に移動
- `[<]`: 前の手に戻る
- `[>]`: 次の手に進む
- `[>|]`: 最新の局面に移動
- `[閲覧モード ON/OFF]`: 閲覧モードと対局モードの切り替え

### 4.2 棋譜表示（オプション）

将棋盤の右側または下部に棋譜リストを表示:

```
1. ７六歩
2. ３四歩
3. ２二角成
...
```

- 現在表示中の手を強調表示
- クリックで該当する局面に直接ジャンプ可能

### 4.3 モード表示

- 閲覧モード: 過去の局面を表示中は「閲覧モード」と表示し、駒の移動を禁止
- 対局モード: 最新の局面を表示中は通常通り対局可能

## 5. 実装ステップ

### 5.1 バックエンド

1. `BoardsController`に`index`アクションを追加
2. `BoardsController`に`show`アクションを追加
3. ルーティングの設定
4. テストの作成

### 5.2 フロントエンド

1. Storeの拡張
   - `boardHistory`と`currentBoardIndex`の追加
   - 関連するアクションの実装
2. APIクライアントの拡張
   - 局面履歴取得メソッドの追加
   - 特定局面取得メソッドの追加
3. UIコンポーネントの実装
   - ナビゲーションコントロールの追加
   - 棋譜表示の実装（オプション）
   - モード切替UIの実装
4. イベントハンドラの実装
   - 各ボタンのクリックイベント処理
   - 棋譜リストのクリックイベント処理

## 6. 注意点と制約

### 6.1 パフォーマンス

- 長時間の対局で局面数が多くなった場合のパフォーマンスを考慮
- 必要に応じて局面履歴の取得にページネーションを実装

### 6.2 UX

- 現在表示中の局面が過去のものか最新のものかを明確に表示
- 閲覧モード中は駒の移動を禁止し、視覚的にフィードバックを提供

### 6.3 エッジケース

- ゲーム開始直後（局面が1つしかない場合）の処理
- エラー発生時のフォールバック処理
- ネットワーク遅延時のローディング表示

## 7. テスト計画

### 7.1 バックエンドテスト

- `BoardsController#index`のテスト
  - 正常系: 局面履歴が正しく取得できること
  - 異常系: 存在しないゲームIDの場合は404を返すこと
- `BoardsController#show`のテスト
  - 正常系: 特定の局面が正しく取得できること
  - 異常系: 存在しない局面IDの場合は404を返すこと

### 7.2 フロントエンドテスト

- Storeのアクションテスト
  - `fetchBoardHistory`が正しく動作すること
  - `goToBoard`が正しく動作すること
  - その他のナビゲーションアクションが正しく動作すること
- コンポーネントテスト
  - ナビゲーションコントロールが正しく表示されること
  - ボタンが適切に有効/無効になること
  - 棋譜リストが正しく表示されること

## 8. 今後の拡張性

- 棋譜の保存と読み込み機能
- 棋譜の分岐対応（変化手順）
- 局面へのコメント追加機能
- 定跡データベースとの連携

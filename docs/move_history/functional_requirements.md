# 将棋GUI 手の履歴機能 - 機能要件

## 概要

本ドキュメントでは、将棋GUIアプリケーションにおける手の履歴機能（棋譜管理機能）の詳細な機能要件を定義します。この機能は、ユーザーが将棋の対局中に指された手の履歴を確認し、任意の局面に戻ったり、異なる手を検討したりすることを可能にします。

## ユースケース

### UC-1: 手の履歴の閲覧

- **アクター**: プレイヤー
- **前提条件**: 対局が開始されている
- **基本フロー**:
  1. プレイヤーは対局画面の手の履歴パネルを確認する
  2. システムは現在までに指された手のリストを時系列順に表示する
  3. 各手には手数と棋譜表記（例：▲７六歩）が表示される
  4. 現在の局面に対応する手がハイライト表示される

### UC-2: 過去の局面への移動

- **アクター**: プレイヤー
- **前提条件**: 少なくとも1手が指されている
- **基本フロー**:
  1. プレイヤーは履歴パネル内の特定の手をクリックする
  2. システムは選択された手の局面を盤面に表示する
  3. 現在選択されている手がハイライト表示される
- **代替フロー**:
  - プレイヤーは操作ボタン（最初へ/前へ/次へ/最後へ）を使用して局面を移動することもできる

### UC-3: 分岐の作成

- **アクター**: プレイヤー
- **前提条件**: プレイヤーが過去の局面に移動している
- **基本フロー**:
  1. プレイヤーは現在表示されている局面で新しい手を指す
  2. システムは新しい分岐として手を記録する
  3. システムは自動的に分岐名を生成する（例：main_1）
  4. 分岐した手以降の手の履歴が更新される

### UC-4: 分岐の切り替え

- **アクター**: プレイヤー
- **前提条件**: 少なくとも1つの分岐が存在する
- **基本フロー**:
  1. プレイヤーは分岐セレクターから確認したい分岐を選択する
  2. システムは選択された分岐の手の履歴を表示する
  3. システムは選択された分岐の最後の局面を盤面に表示する

### UC-5: 最初の局面への移動

- **アクター**: プレイヤー
- **前提条件**: 対局が開始されている
- **基本フロー**:
  1. プレイヤーは「最初へ」ボタンをクリックする
  2. システムは対局開始時の初期局面を表示する

### UC-6: 最新の局面への移動

- **アクター**: プレイヤー
- **前提条件**: プレイヤーが過去の局面を閲覧している
- **基本フロー**:
  1. プレイヤーは「最後へ」ボタンをクリックする
  2. システムは現在の分岐における最新の局面を表示する

## 機能要件

### FR-1: 手の履歴の記録

1. システムは対局中のすべての指し手を時系列順に記録する
2. 各手に対して、以下の情報を保存する：
   - ゲームID
   - 局面情報（SFEN形式）
   - 手数
   - 分岐名
   - 作成日時
3. 移動元・移動先・駒の種類などの手の詳細情報はSFEN形式から算出する

### FR-2: 手の履歴の表示

1. 手の履歴パネルは各手を時系列順に表示する
2. 各手の表示内容：
   - 手数
   - 棋譜表記（例：▲７六歩、△８四歩）
3. 現在表示中の手をハイライト表示する
4. 履歴パネルはスクロール可能であること

### FR-3: 局面の移動機能

1. 手の履歴内の任意の手をクリックして対応する局面に移動できる
2. 以下のナビゲーションボタンを提供する：
   - 最初の局面へ移動
   - 一手前の局面へ移動
   - 一手先の局面へ移動
   - 最後の局面へ移動
3. 局面が変更されたとき、対応する盤面が更新される
4. 局面移動時に駒の配置が変わるだけでなく、手番も正しく更新される

### FR-4: 分岐管理

1. 過去の局面から新しい手を指した場合、自動的に分岐を作成する
2. 分岐名は以下の規則で自動生成する：
   - 元の分岐名が「main」の場合、新しい分岐は「main_1」となる
   - 既に「main_1」が存在する場合、次は「main_2」となる
3. 分岐セレクターを提供し、ユーザーが別の分岐に切り替えられるようにする
4. 分岐切り替え時には、その分岐の最新局面を表示する

### FR-5: 棋譜表記の生成

1. 指された手を日本語の棋譜形式で表示する
2. 表記例：
   - ▲７六歩：先手が７六に歩を進めた
   - △８四歩：後手が８四に歩を進めた
   - ▲２二角成：先手が２二に角を動かし、成った
3. 駒の表記は日本語とする（歩、香、桂、銀、金、角、飛、玉）
4. 成駒は適切に表示する（成桂、成銀、馬、龍）

### FR-6: 初期局面の保存

1. 対局開始時の初期局面を手数0として保存する
2. 初期局面は「開始局面」として表示する

### FR-7: API設計

1. 局面履歴を取得するAPI
   - `GET /api/v1/games/:game_id/board_histories`
   - クエリパラメータ：`branch`（任意、デフォルトは「main」）
2. 分岐リストを取得するAPI
   - `GET /api/v1/games/:game_id/board_histories/branches`
3. 指定した手数の局面に移動するAPI
   - `POST /api/v1/games/:game_id/navigate_to/:move_number`
   - クエリパラメータ：`branch`（任意、デフォルトは「main」）
4. 分岐を切り替えるAPI
   - `POST /api/v1/games/:game_id/switch_branch/:branch_name`

## 非機能要件

### NFR-1: パフォーマンス

1. 履歴パネルの表示は300ms以内に完了すること
2. 局面移動は500ms以内に完了すること
3. 長い対局（100手以上）でもスムーズに動作すること

### NFR-2: 信頼性

1. ゲームの状態変更はデータベースに即時保存され、クラッシュしても復元可能であること
2. 不正な操作（例：存在しない分岐への切り替え）に対して適切なエラーメッセージを表示すること

### NFR-3: 使いやすさ

1. 履歴パネルは直感的に使用できること
2. ナビゲーションボタンは視認性が高く、クリックしやすいサイズであること
3. 現在の局面が常に明確にわかるようにすること

### NFR-4: 保守性

1. コードは拡張性を考慮して設計すること
2. 将来的な機能追加（例：コメント機能、評価値表示）に対応できる構造にすること

### NFR-5: モバイル対応

1. レスポンシブデザインにより、モバイルデバイスでも使用可能にすること
2. タッチスクリーンでの操作に最適化すること

## 制約条件

1. 履歴機能は既存のゲームシステムを破壊することなく統合されること
2. 既存のAPIとの互換性を維持すること
3. データベーススキーマの変更は最小限に抑えること

## 将来の拡張可能性

1. 分岐に対するカスタム名の設定
2. 局面へのコメント追加機能
3. AIによる局面評価連携
4. 棋譜のエクスポート/インポート機能
5. 局面のブックマーク機能 